---
title: network
---
# CS144

## 四层网络模型

![image-20210814210718978](http://img.gxyhero.top/img/202108142107078.png)

区别于课堂上所学习的OSI七层网络模型，这里使用的是简化的4层。

![image-20210814213008112](http://img.gxyhero.top/img/202108142130178.png)

其中网络层较为特殊，它必须使用**IP(Internet Protocol)协议**，IP协议具有以下特点：

1. IP提供尽力而为的数据传递服务
2. IP数据包可能会丢失可能会乱序，即它本身不保证数据的可靠性

为了保证数据的可靠性，需要IP的上层协议，即传输层协议，最为常见的就是**TCP(Transmission Control Protocol)协议**，TCP/IP的意思就是应用程序同时使用了TCP协议和IP协议。

TCP是可靠传输的，它弥补了IP的缺陷。

分层的网络模型充分体现了**关注分离**的设计思想，将整个网络连接拆分为多个对等层之间的连接，其优势在后续有提及。

![image-20210814212727474](http://img.gxyhero.top/img/202108142127612.png)

------



## IP服务模型

如图，数据在四层网络模型中采取嵌套的方式传递：![image-20210814213445365](http://img.gxyhero.top/img/202108142134411.png)

即上层的数据报会被封装在下层数据报的数据部分。接下来详细说说IP协议的四个特点：

1. 数据采用独立的数据报形式"逐跳"路由
2. 不可靠，数据可能会丢失，而且IP不会通知这一行为
3. 尽力，不到万不得已的情况IP不会轻易抛弃数据
4. 无连接，因为每个数据包是独立的，所以数据包的到达也是无顺序的

为什么IP被设计得如此简单？

1. 简单、快捷、维护成本更低
2. 端到端通信原则，**where possible , implement features in the end host**
3. 允许上层建立更多样得服务，如TCP、UDP
4. 对下层几乎没有要求，甚至可以建立在信鸽上

这是一个典型的IPv4数据包结构：

![image-20210814220336468](http://img.gxyhero.top/img/202108142203537.png)

值得注意的是以下几个字段：

1. Flags和Fragment Offset，它们用于数据包的分割，因为IP携带的数据长度有限
2. TTL，防止数据包沿回路无限传递
3. Checksum 确保**IP首部**的准确

------



## 数据包的一生

本节通过以下三种软件/命令分析数据包的一生：

1. 通过wireshake分析传输层
2. 通过`tracert`分析网络层
3. 通过`route print`查看本地路由表分析链路层

<img src="http://img.gxyhero.top/img/202108150031281.png" alt="image-20210815003111245" style="zoom:150%;" />

如图，截取的是TCP建立连接的三次握手报文，这里常问的问题就是：

```markdown
**为什么TCP建立连接需要三次握手？**

根本原因与上一节的IP有关，因为TCP是建立在IP之上的协议，而IP本身是不可靠的。TCP需要在这样一个不可靠的信道中建立可靠连接，就需要通信双方都确认，即理论上需要四步：

1. client向serve确认是否可以通信？
2. serve向client回复
3. serve向client确认是否可以通信？
4. client回复serve

将第二步与第三步相结合，就是TCP三次握手。
```

那么数据是如何从本机192.168.2.209传输到14.215.177.38的呢？

通过`tracert`命令可以看到详细的过程：

![image-20210815010046973](http://img.gxyhero.top/img/202108150100007.png)

可以看到数据包经过了11个hop到达目标地址。

每一跳都是由所在路由器/主机的路由表来控制，通过`route print`指令可以查看本机路由表：

![image-20210815011220797](http://img.gxyhero.top/img/202108150112836.png)

第一条为缺省路由，第二条第三条均为本地环路，第四条为本地广播路由。

```markdown
**127.0.0.1和localhost的区别**
1. 同样是指向本机，在调试的时候常用localhost。
2. localhost跟域名很像。
3. localhost不走网卡，而127.0.0.1则需要经过网卡和防火墙，这两者是非同源的。
```

------



## 三个原理

三个原理分别是：

1. 数据包交换原理
2. 分层原理
3. 封装原理

### 数据包交换原理

数据包的交换是**简单的**，它体现在路由器无需记住每一个数据流的状态，只需要关注转发每一个独立的数据包。

这里提及了一个过时的概念**“源路由”**，即不依赖转发表而在最初就将路由路径设定好，这个方案已经被废弃，因为安全问题，源可以控制整个路由路径这是非常危险的。

数据包的交换是**高效的**，它采取**统计复用**的方式按需地分配信道资源。

### 分层原理

![image-20210815020627326](http://img.gxyhero.top/img/202108150206401.png)

分层原理具有如下几个特点：

1. 模块化，更方便管理维护
2. 定义明确的服务，每层都为上一层提供了明确的服务
3. 复用，可以在已有的层基础上编写上层
4. 关注分离，每层只需关注自己的工作，而不需要关注其他层工作的具体实现
5. 持续提高

但是分层也有缺点，表现在跨越层来提高性能不方便。

以C语言编程为例：

linux上下文切换程序集，为ARM编写的代码仅适用于ARM，想要在其他架构上使用就需要重新编写新的汇编代码，这样跨层的性能提升不再独立于下次，极大限制了编程的灵活性。



